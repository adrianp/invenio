{#
## This file is part of Invenio.
## Copyright (C) 2013 CERN.
##
## Invenio is free software; you can redistribute it and/or
## modify it under the terms of the GNU General Public License as
## published by the Free Software Foundation; either version 2 of the
## License, or (at your option) any later version.
##
## Invenio is distributed in the hope that it will be useful, but
## WITHOUT ANY WARRANTY; without even the implied warranty of
## MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
## General Public License for more details.
##
## You should have received a copy of the GNU General Public License
## along with Invenio; if not, write to the Free Software Foundation, Inc.,
## 59 Temple Place, Suite 330, Boston, MA 02111-1307, USA.
#}

{%- if not request.is_xhr -%}
  {%- extends "records/base.html" -%}
{%- endif -%}

{%- css url_for('comments.static', filename='css/comments/comments.css'), '10-comments' -%}
{%- js url_for('comments.static', filename='js/comments/comments.js'), '10-comments' -%}

{%- if config.CFG_COMMENTS_NOTES_ENABLED -%}
  {%- js url_for('comments.static', filename='js/comments/notes_popover.js'), '10-comments' -%}
{%- endif -%}

{%- if config.CFG_COMMENTS_PREVIEW_ENABLED -%}
  {%- js url_for('comments.static', filename='js/comments/pdf_viewer.js'), '10-comments' -%}
{%- endif -%}

{%- if config.CFG_COMMENTS_PREVIEW_ENABLED and config.CFG_COMMENTS_NOTES_ENABLED -%}
  {%- js url_for('comments.static', filename='js/comments/pdf_notes_helpers.js'), '10-comments' -%}
{%- endif -%}

{%- macro controls() -%}
  <div class="pull-right">
    {%- if option == 'comments' -%}
      {%- if current_user.is_guest -%}
        <a id="add-comment" class="btn" href="{{ url_for('webaccount.login', referer=request.url) }}">
      {%- else -%}
        <a id="add-comment" class="btn" data-toggle="modal" data-href="{{ url_for('comments.add_comment', recid=recid) }}">
      {%- endif-%}
          <i class="icon-pencil"></i>
          {{ _('write comment') }}
       </a>
    {%- elif option == 'notes' and config.CFG_COMMENTS_PREVIEW_ENABLED -%}
        <button id="all-notes-toggle" type="button" class="btn btn-default">
          <i class="icon-eye-open"></i>
          Show all notes
        </button>
    {%- endif -%}

    &nbsp;

    {%- if config.CFG_COMMENTS_NOTES_ENABLED -%}
      <div class="btn-group">
        {%- if option == 'comments' -%}
          <a class="btn active" href="{{ url_for('comments.comments', recid=recid) }}">
        {%- else -%}
          <a class="btn" href="{{ url_for('comments.comments', recid=recid) }}">
        {%- endif -%}
            {{ _('Comments') }}
          </a>
        {%- if option == 'notes' -%}
          <a class="btn active" href="{{ url_for('comments.notes', recid=recid) }}">
        {%- else -%}
          <a class="btn" href="{{ url_for('comments.notes', recid=recid) }}">
        {%- endif -%}
            {{ _('Notes') }}
          </a>
      </div>
    {%- endif -%}
  </div>
{%- endmacro %}

{%- macro pdf_pane() -%}
    {%- if config.CFG_COMMENTS_PREVIEW_ENABLED -%}
        <div class="span6">
            <div class="centered">
                <div class="btn-group">
                    <button class="btn" id="frst-page">«</button>
                    <button class="btn" id="prev-page">‹</button>
                </div>
                <small id="page-counter"></small>
                <div class="btn-group">
                    <button class="btn" id="next-page">›</button>
                    <button class="btn" id="last-page">»</button>
                </div>
            </div>
            <div id="pdf-preview"
                 data-toggle="modal"
                 data-href="{{ url_for('comments.add_comment', recid=recid) }}"
                 data-href-login="{{ url_for('webaccount.login', referer=request.url) }}"
                 class="centered"
                 title="{{ _("Click to add comment on this page") }}">
                {{ _('Preview not available yet.') }}
            </div>
        </div>
    {%- endif -%}
{%- endmacro %}

{%- block record_content -%}

  {%- from "_translate.html" import translate -%}
  {{ translate(["Page", "of"]) }}

  <div class="page-header">
    {{ format_record(recid, 'hs', ln=g.ln)|safe }}
  </div>

  <div class="page-header">
    <h4>
      {%- if option == 'comments' -%}
        {{ _("Comments") }}
      {%- elif option == 'notes' -%}
        {{_('Notes')}}
      {%- endif -%}

      <div class="pull-right">
        <small>
          {{ controls() }}
        </small>
      </div>  <!-- /pull-right -->
    </h4>
  </div>  <!-- /page-header -->

  {%- block custom -%}
    {#{ controls() }#}
  {%- endblock custom -%}

  <div style="clear:both"/></div>
  <hr/>

  {%- if record.user_comment_subscritions|length -%}
    <div class="alert">
      {%- set info_subs =
        _('%(open_tag)s Unsubscribe %(close_tag)s from this discussion. You will not receive any new comments by email.') % {
          'open_tag': '<strong><a href="'+url_for('comments.unsubscribe', recid=recid)+'"><i class="icon-trash"></i>',
          'close_tag':'</a></strong>'} -%}
      {{ info_subs|safe }}
    </div>
  {%- else -%}
    <div class="alert alert-info">
      {%- set info_subs =
        _('%(open_tag)s Subscribe %(close_tag)s to this discussion. You will then receive all new comments by email.') % {
          'open_tag': '<strong><a href="'+url_for('comments.subscribe', recid=recid)+'"><i class="icon-envelope"></i>',
          'close_tag':'</a></strong>'} -%}
      {{ info_subs|safe }}
    </div>
  {%- endif -%}

{%- endblock record_content -%}
